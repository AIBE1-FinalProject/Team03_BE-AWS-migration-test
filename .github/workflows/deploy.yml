name: Deploy to EC2

on:
  push:
    branches:
      - main # main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œë§Œ ë°°í¬ë˜ë„ë¡ ì„¤ì • (ì¼ë°˜ì ìœ¼ë¡œ ì•ˆì •ì ì¸ ë¸Œëœì¹˜)
  workflow_run:
    workflows: [ "Backend CI" ]  # backend-ci.yml ì•ˆì˜ workflow ì´ë¦„
    types:
      - completed              # ì™„ë£Œ ì‹œ ì‹¤í–‰

jobs:
  deploy:
    name: Deploy Backend to EC2
    runs-on: ubuntu-latest # AWS EC2 ì¸ìŠ¤í„´ìŠ¤ì— ì—°ê²°í•˜ê¸° ìœ„í•œ ì‹¤í–‰ í™˜ê²½

    steps:
      - name: Connect to EC2 and Deploy Docker Container
        uses: appleboy/ssh-action@master # SSH ì ‘ì†ì„ ìœ„í•œ GitHub Action ì‚¬ìš©
        with:
          host: '${{ secrets.EC2_HOST }}' # EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ í¼ë¸”ë¦­ IP ë˜ëŠ” DNS (GitHub Secretsì—ì„œ ê°€ì ¸ì˜´)
          username: '${{ secrets.EC2_USER }}' # EC2 ì¸ìŠ¤í„´ìŠ¤ ì ‘ì† ì‚¬ìš©ìëª… (ì˜ˆ: ec2-user)
          key: '${{ secrets.EC2_KEY }}' # EC2 ì ‘ì†ìš© í”„ë¼ì´ë¹— í‚¤ (GitHub Secretsì—ì„œ ê°€ì ¸ì˜´)
          script: |
            echo "âœ… EC2 ì ‘ì† ì™„ë£Œ. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
            docker stop ticketmon-backend || true # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ (ì—†ìœ¼ë©´ ì˜¤ë¥˜ ë¬´ì‹œ)
            docker rm ticketmon-backend || true   # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì‚­ì œ (ì—†ìœ¼ë©´ ì˜¤ë¥˜ ë¬´ì‹œ)

            echo "â¬‡ï¸ ìµœì‹  Docker ì´ë¯¸ì§€ Pull ì¤‘..."
            docker pull ghcr.io/${{ secrets.DOCKER_IMAGE_REPO }}:latest # ìˆ˜ì •ëœ ì´ë¯¸ì§€ ê²½ë¡œ ì‚¬ìš©
            
            echo "ğŸš€ ìƒˆ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘..."
            docker run -d \
            --name ticketmon-backend \
            -p 80:8080 \
            # --- ğŸ‘‡ ì—¬ê¸°ì— ëª¨ë“  í•„ìš”í•œ í™˜ê²½ ë³€ìˆ˜ ì¶”ê°€ ğŸ‘‡ ---
            -e SPRING_PROFILES_ACTIVE=prod \
            -e DB_URL='${{ secrets.DB_URL }}' \
            -e DB_USERNAME='${{ secrets.DB_USERNAME }}' \
            -e DB_PASSWORD='${{ secrets.DB_PASSWORD }}' \
            -e SPRING_DATA_REDIS_HOST='${{ secrets.SPRING_DATA_REDIS_HOST }}' \
            -e SPRING_DATA_REDIS_PORT='${{ secrets.SPRING_DATA_REDIS_PORT }}' \
            -e SPRING_DATA_REDIS_USERNAME='${{ secrets.SPRING_DATA_REDIS_USERNAME }}' \
            -e SPRING_DATA_REDIS_PASSWORD='${{ secrets.SPRING_DATA_REDIS_PASSWORD }}' \
            -e AWS_ACCESS_KEY_ID='${{ secrets.AWS_ACCESS_KEY_ID }}' \
            -e AWS_SECRET_ACCESS_KEY='${{ secrets.AWS_SECRET_ACCESS_KEY }}' \
            -e JWT_SECRET_KEY='${{ secrets.JWT_SECRET_KEY }}' \
            -e JWT_ACCESS_EXPIRATION_MS='${{ secrets.JWT_ACCESS_EXPIRATION_MS }}' \
            -e JWT_REFRESH_EXPIRATION_MS='${{ secrets.JWT_REFRESH_EXPIRATION_MS }}' \
            -e SQS_ENDPOINT='${{ secrets.SQS_ENDPOINT }}' \
            -e AWS_ACCESS_KEY='${{ secrets.AWS_ACCESS_KEY }}' \ # application-prod.ymlì—ì„œ AWS_ACCESS_KEY_IDë¡œ í†µì¼í•˜ë©´ ì œê±° ê°€ëŠ¥
            -e AWS_SECRET_KEY='${{ secrets.AWS_SECRET_KEY }}' \ # application-prod.ymlì—ì„œ AWS_SECRET_ACCESS_KEYë¡œ í†µì¼í•˜ë©´ ì œê±° ê°€ëŠ¥
            -e TOSS_CLIENT_KEY='${{ secrets.TOSS_CLIENT_KEY }}' \
            -e TOSS_SECRET_KEY='${{ secrets.TOSS_SECRET_KEY }}' \
            -e TOGETHER_API_KEY='${{ secrets.TOGETHER_API_KEY }}' \
            -e BASE_URL='${{ secrets.BASE_URL }}' \
            # --- ğŸ‘† ì—¬ê¸°ì— ëª¨ë“  í•„ìš”í•œ í™˜ê²½ ë³€ìˆ˜ ì¶”ê°€ ğŸ‘† ---
            # -v /home/ec2-user/app/application-prod.yml:/app/config/application-prod.yml \ # ì£¼ì„ ì²˜ë¦¬ ë˜ëŠ” ì œê±° (í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš© ì‹œ)
            ghcr.io/${{ secrets.DOCKER_IMAGE_REPO }}:latest # ìˆ˜ì •ëœ ì´ë¯¸ì§€ ê²½ë¡œ ì‚¬ìš©
            
            echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"